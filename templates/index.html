<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIME</title>
    <style>
        body {
            font-family: Serif, garamond;
            margin: 0;
            padding: 10px;
            background-color: #f4f9f4;
            color: #2c3e50;
            text-align: left;
            font-size: 22px;
            opacity: 0;
            transition: opacity 0.1s ease;
        }
        body.loaded {
            opacity: 1;
        }
        .container {
            margin: 10px auto;
            padding: 20px 20px;  /* Remove top padding */
            background-color: #d6e9c6;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.0);
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background-color: #a0cfa5;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            margin: -20px -20px 20px -20px;
            z-index: 1;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }   
        .logo {
            width: 65px;
            height: auto;
            display: block;
        }

        h1 {
            color: #444544;
            font-size: 70px; /* Slightly reduced for better spacing */
            margin: 0;        /* Remove default spacing */
            padding: 0;
            line-height: 1.1; /* Tighter line spacing */
        }
        
        h2 {
            color: #2c3e50;
            font-size: 24px;  
            flex-grow: 1;
            margin: 5px 0 0 0; 
            line-height: 1.2;
        }

        h3 {
            color: #ee4b2b;
            font-size: 28px;
        }
        
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            color: #333232;
            font-size: 22px;
        }
        input, select {
            width: 90%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #ffffff;
            color: #333232;
            display: inline-block;
            font-size: 22px;
        }
        input:read-only {
            background-color: #e9ecef;
        }
        .tabs-container {
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
        }

        .tabs {
            display: flex;
            gap: 10px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #46754a;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            transition: background-color 0.3s ease;
        }

        .active-tab {
            background-color: #2c3e50; 
        }
        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        
        .tab-content.active-content {
            display: block;
            opacity: 1;
        }
        .active-content {
            display: block;
        }
        .citation a {
            text-decoration: none;  /* Removes underline */
            color: #3643f3;  /* Keeps citation color */
        }
        .citation a:hover {
            text-decoration: underline;  /* Underlines on hover for clarity */
        }    
        .mathjax {
            font-family: 'Times New Roman', serif;
            font-size: 18px;
        }
        .button-container {
            display: flex;
            align-items: left;
            gap: 15px; 
            justify-content: left;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            background-color: #46754a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 25px;
            width: 150px;
            text-align: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }        
        button:hover {
            background-color: #46754a;
            transform: scale(1.03); 
        }        
        .loading-container {
            display: none;
            align-items: center;
        }
        
        .loading-container img {
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
    
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }
        .input-container > div {
            flex: 1 1 22%; /* Default: 4 in a row */
            min-width: 200px;
            box-sizing: border-box;
        }
        /* 2 per row on medium screens */
        @media (max-width: 1300px) {
            .input-container > div {
                flex: 1 1 45%;
            }
        }
        /* 1 per row on small screens */
        @media (max-width: 650px) {
            .input-container > div {
                flex: 1 1 100%;
            }
        }

        .logos-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 40px;
        }
        .logos-container img {
            margin: 0 20px;
        }

    .logo-ku,
    .logo-erc,
    .logo-fwo {
        height: auto;
        max-width: 150px;
        width: 100%;
    }
    /* Scale down on tablets */
    @media (max-width: 900px) {
        .logo-ku,
        .logo-erc,
        .logo-fwo {
            max-width: 120px;
        }
    }
    /* Scale down more on phones */
    @media (max-width: 500px) {
        .logo-ku,
        .logo-erc,
        .logo-fwo {
            max-width: 90px;
        }
    }

    .tooltip {
        position: relative;
        display: inline-block;
        cursor: pointer;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 300px;
        background-color: #b6b7b8;
        color: #2e2c2c;
        text-align: center;
        padding: 10px;
        border-radius: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -150px;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }


    /* Hide number input arrows */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type="number"] {
        -moz-appearance: textfield;
    }

    table {
        width: 50%;
        border-collapse: separate;
        border-spacing: 0;
        margin: 20px auto;
        font-size: 22px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* 75% width on medium screens */
    @media (max-width: 1300px) {
        table {
            width: 75%;
            margin: 20px auto;
            font-size: 18px;
        }
    }

    /* Full width on small screens */
    @media (max-width: 650px) {
        table {
            width: 95%;
            margin: 20px auto;
            font-size: 18px;
        }
    }


    th, td {
        padding: 12px;
        text-align: left;
    }

    @media (max-width: 600px) {
        th, td {
            padding: 10px;
        }
    }

    th {
        background-color: #46754a;
        color: white;
    }

    tr:nth-child(even) {
        background-color: #ECF0F1;
    }

    tr:hover {
        background-color: #BDC3C7;
    }

    /* Hide by default */
    .mobile-menu-icon {
        display: none;
        font-size: 28px;
        cursor: pointer;
        margin-right: 10px;
    }

    .mobile-sidebar {
        display: none;
        position: fixed;
        top: 0;
        right: -100%;
        height: 100%;
        width: 240px;
        background-color: #a0cfa5;
        box-shadow: -3px 0 10px rgba(0, 0, 0, 0.2);
        padding: 20px;
        flex-direction: column;
        gap: 15px;
        transition: right 0.3s ease;
        z-index: 1000;
    }

    .mobile-sidebar.show {
        right: 0;
        display: flex;
    }

    .mobile-sidebar .close-btn {
        align-self: flex-end;
        font-size: 28px;
        cursor: pointer;
        margin-bottom: 10px;
    }

    /* Mobile view only */
    @media (max-width: 768px) {
        .tabs-container {
            display: none; /* Hide desktop tabs */
        }

        .mobile-menu-icon {
            display: block; /* Show hamburger */
        }
    }

        /* Small phones */
    @media (max-width: 480px) {
        body {
            font-size: 16px;
        }

        h1 {
            font-size: 36px;
        }

        h2 {
            font-size: 18px;
        }

        h3 {
            font-size: 20px;
        }

        label,
        input,
        select,
        table,
        .tab,
        button {
            font-size: 16px;
        }

        .tab {
            padding: 8px 10px;
        }
    }

    /* Tablets and medium phones */
    @media (min-width: 481px) and (max-width: 768px) {
        body {
            font-size: 18px;
        }

        h1 {
            font-size: 48px;
        }

        h2 {
            font-size: 20px;
        }

        h3 {
            font-size: 22px;
        }

        label,
        input,
        select,
        table,
        .tab,
        button {
            font-size: 18px;
        }
    }

    pre {
        background-color: #a0cfa5;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        font-family: monospace;
        font-size: 16px;
        max-width: 100%;
        box-sizing: border-box;
<!--        margin: 10px 0;-->
    }
    /* Optional: scale font down on small screens */
    @media (max-width: 500px) {
        pre {
            font-size: 14px;
        }
    }

    </style>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>    
           
</head>
<body>
    <div class="container">
        <div class="header">

            <!-- Mobile Hamburger Menu -->
            <div class="mobile-menu-icon" onclick="toggleSidebar()">☰</div>
            <!-- Sidebar Menu -->
            <div class="mobile-sidebar" id="mobileSidebar">
                <div class="close-btn" onclick="toggleSidebar()">×</div>
                <button class="tab" onclick="navigateToTab('info'); toggleSidebar()">Tool Info</button>
                <button class="tab" onclick="navigateToTab('calculator'); toggleSidebar()">Calculator</button>
                <button class="tab" onclick="navigateToTab('batch'); toggleSidebar()">Batch Calculator</button>
                <button class="tab" onclick="navigateToTab('contact'); toggleSidebar()">Contact</button>
            </div>

            <div class="header-left">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="MCAK-Mforce Logo" class="logo">
                <h1>LIME</h1>
                <h2>Line-driven-wind Iterative Mass-loss Estimator</h2>
            </div>
        
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab" onclick="navigateToTab('info')">Tool Info</button>
                    <button class="tab" onclick="navigateToTab('calculator')">Calculator</button>
                    <button class="tab" onclick="navigateToTab('batch')">Batch Calculator</button>
                    <button class="tab" onclick="navigateToTab('contact')">Contact</button>
                </div>
            </div>
        </div>
        
        <!-- Tab contents -->
        <div id="info" class="tab-content active-content">
            <h2>Overview</h2>

            <p>This online tool is designed to provide a fast, efficient, user-friendly, real-time mass-loss calculator for line-driven winds from hot, massive stars with given basic stellar parameters and arbitrary chemical compositions (as long as the theory allows for it).</p>
            <p>The line force is computed on-the-fly from excitation and ionization balance calculations using the “Munich Atomic Database”  
                  <span class="citation">
                    (<a href="https://doi.org/10.1051/aas:2000312" target="_blank">Puls et al. 2000</a>; <a href="https://doi.org/10.1051/0004-6361:20010805" target="_blank">Pauldrach et al. 2001</a>) 
                </span> consisting of more than 4 million spectral lines. Mass-loss rates are then derived from line-driven wind theory, including effects of a finite stellar disk and gas sound speed. The line-force parameters are calculated following the formalisms by              
                <span class="citation">
                    <a href="https://doi.org/10.1086/176492" target="_blank">Gayley (1995)</a>; <a href="https://doi.org/10.48550/arXiv.2204.09981" target="_blank">Poniatowski et al. (2022)</a>.
                </span>
                For a given set of stellar parameters and chemical composition, we obtain predictions for mass-loss rates and the three line-force parameters \(\rm \bar{Q}\), \(\rm Q_0\), and \(\rm \alpha\) at the wind critical point.
                Additionally, we also provide a (less exact) estimate of the terminal wind speed. This is based on the fitting-formula in
                <span class="citation">
                    <a href="https://doi.org/10.1146/annurev.astro.38.1.613" target="_blank">Kudritzki & Puls (2000)</a>,
                </span>
                 using line-force parameters as given by LIME.
                As such, it does not take into account differences in line-driving efficiency between the wind critical point and the outer wind.</p>
            <p>In addition to its speed and simplicity, a strength of our mass-loss calculator is that it avoids uncertainties related to applying fit formulae to underlying model grids calculated for more restricted parameter ranges. Moreover, individual chemical abundances can be trivially modified, and their effects upon predicted mass-loss rates explored. This thus also allows for potential applications toward stars that are significantly chemically modified at the surface.</p>
            <p><strong> Further Reading:</strong> For more in depth understanding of line-driven stellar wind theory, you can refer to the <a href="{{ url_for('static', filename='Line_Driven_Theory_Notes.pdf') }}" download style="color: rgb(86, 97, 245); text-decoration: none; font-weight: bold;"> lecture notes</a>
                by Prof. Jon Sundqvist.  
            </p>

            <h2>Credits</h2>
            <p> <strong> If you use LIME for your work, please cite <span class="citation">Sundqvist, Debnath, Backs et al. 2025</span> and also provide a footnote with the URL of this website. </strong> </p>

            <p>This tool has been developed by the 
                <span class="citation">
                    <a href="https://fys.kuleuven.be/ster/research-projects/equation-folder/equation-home" target="_blank">EQUATION</a> 
                </span>
                group (led by Prof. Jon Sundqvist) with funding from KU Leuven, European Research Council (ERC) and Fonds voor Wetenschappelijk Onderzoek – Vlaanderen (FWO).</p>
        </div>

        <div id="contact" class="tab-content">
            <h2>Contact Us</h2>
            <p>If you have any questions or feedback, feel free to reach out to us using the form below.</p>
        
            <div class="input-container">
                <div>
                    <label for="contact-name">Name:</label>
                    <input type="text" id="contact-name" placeholder="Enter your name">
                </div>
                <div>
                    <label for="contact-email">Email:</label>
                    <input type="email" id="contact-email" placeholder="Enter your email">
                </div>
            </div>
        
            <div>
                <label for="contact-message">Message:</label>
                <textarea id="contact-message" placeholder="Write your message here" rows="7" style="width: 50%;"></textarea>
            </div>
        
            <div>
                <label for="contact-attachment">Attachment (optional, CSV and PDF only):</label>
                <input type="file" id="contact-attachment" accept=".csv, .pdf">
            </div>
        
            <div class="button-container">
                <button onclick="sendContactForm()">Send Message</button>
            </div>
        </div>
                
                          
        <div id="calculator" class="tab-content">
            <p> The data is reliable only for effective temperatures (\(\rm T_{eff}\)) between 18,000 K and 60,000 K. 
                Outside this range, the available ionization stages in the Munich Atomic Database become more limited.
                We are actively working on extending the database, and future updates will aim to cover larger temperature range. </p>
             
            <p> <strong> Additionally, please ensure that pop-ups are enabled in your browser for the results to display correctly.</strong> </p>
             
            <h2>Enter Stellar Parameters</h2>
            <div class="input-container">
                <div>
                    <label for="luminosity">Luminosity (\(\rm L_\odot\)):</label>
                    <input type="number" id="luminosity" step="any">
                </div>
            
                <div>
                    <label for="teff">Effective Temperature (\(\rm K)\):</label>
                    <input type="number" id="teff" step="any">
                </div>
            
                <div>
                    <label for="mstar">Stellar Mass (\(\rm M_\odot\)):</label>
                    <input type="number" id="mstar" step="any">
                </div>
            
                <div>
                    <label for="zscale">Metallicity (\(\rm Z_{\odot}\)):</label>
                    <input type="number" id="zscale" step="any" onblur="updateAbundances()">
                </div>
            </div>            
            <div class="button-container">
                <button id="runButton" onclick="runCalculation()">Run</button>
                <div id="loading" class="loading-container">
                    <img src="{{ url_for('static', filename='loading.gif') }}" alt="Loading">
                </div>
            </div>

<!--            A table to show the output-->

            <h3> <span id="extra_info" > </span> </h3>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Output</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Mass-loss rate (\(\dot{M}\))</td>
                        <td id="mass_loss_rate"> </td>
<!--                        <td> {{ data.mass_loss_rate }} </td>-->
                    </tr>
                    <tr>
                        <td>Terminal velocity (\(v_{\infty}\))</td>
                        <td id="terminal_velocity"> </td>
<!--                        <td> {{ data.terminal_velocity }} </td>-->
                    </tr>
                    <tr>
                        <td>Eddington ratio (\(\Gamma\))</td>
                        <td id="gamma_e"> </td>
                    </tr>
                    <tr>
                        <td>\(\bar{Q}\) (Qbar)</td>
                        <td id="qbar"> </td>
                    </tr>
                    <tr>
                        <td>\(\alpha\)</td>
                        <td id="alpha"> </td>
                    </tr>
                    <tr>
                        <td>\(Q_0\)</td>
                        <td id="q0"> </td>
                    </tr>
                </tbody>
            </table>

            <div style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
                <label class="switch">
                    <input type="checkbox" id="email-toggle" onchange="toggleEmailInput()">
                    <span class="slider"></span>
                </label>
                <label for="email-toggle" style="font-size: 22px; color: #333;">Receive a copy via email</label>
                <label class="switch">
                    <input type="checkbox" id="expert-toggle">
                    <span class="slider"></span>
                </label>
                <label for="expert-toggle" style="font-size: 22px; color: #333;">Expert Outputs</label>
            </div>
            
            <div id="email-input-container" style="display: none; margin-top: 10px;">
                <label for="user-email">Enter your email:</label>
                <input type="email" id="user-email" placeholder="example@example.com">
            </div>
            
            <h2>Mass fractions</h2>
                <p> Input the mass fraction of each element. The default numbers are based on the
                    <span class="citation">
                    <a href="https://doi.org/10.48550/arXiv.0909.0948" target="_blank">Asplund et al. (2009)</a>
                    </span> solar abundances, scaled with the input metallicity above. These can be adjusted. To make
                    sure the total remains unity, we rescale the hydrogen mass fraction. The total excluding hydrogen
                    cannot exceed unity.
                    <p>

                                    
            <div id="abundances"></div>
        </div>
        
        <div id="batch" class="tab-content">
            <p> The atomic line data set should only be trusted for effective temperature (\(\rm T_{eff}\)) between 18000 to 60000 K.
                Beyond this limit, the underlying Munich Atomic Database either lacks ionization stages or has limited data.
                We are currently working on an extension to the Munich Atomic Database, and future updates will aim to cover larger temperature range.
            <p>
            <p>You can submit a CSV (comma-separated values) file containing the stellar inputs and abundances.
            The processed results will be emailed back once completed. Up to 200 inputs can be processed per batch. </p>
            <h2>User Info</h2>
            <div class="input-container">
                <label for="email-grid">Enter your email id:</label>
                <input type="email" id="email-grid", placeholder="example@example.com", name="email" required>
            </div>
            
            <h2>Upload CSV File</h2>
            <p>Please upload a CSV file containing stellar parameters. The first row should include the column names as follows:</p>
            <ul>
                <li><strong>Required columns:</strong> name, luminosity (in \(\rm L_\odot\)), effective temeparture (in \(\rm K \)), mass of the star (in \(\rm M_\odot\)), scaling metallicity (in \(\rm Z_{\odot}\)), and mass fraction of helium (HE)</li>
                <li><strong>Optional columns:</strong> Individual mass fractions of elements (e.g., H, C, N, O, MN, FE etc.)</li>
            </ul>
            <p style="color:#333232; font-weight: bold;">
                ⚠️ Column names must be EXACTLY as shown below (case-sensitive).
                Ensure HE, luminosity, teff, etc., are written with correct capitalization.
            </p>
            <pre>
name, luminosity, teff, mstar, zscale, HE, C, N, FE
Star1, 500000, 40000, 52, 1.0, 0.243, 0.0002, 0.0000065, 0.00000045
Star2, 200000, 21000, 20, 0.2, 0.280, 0.00005, 0.000000007, 0.0000000013</pre>
            <div class="input-container">
                <input type="file" id="csvFile" accept=".csv">
            </div>
            
            <div class="button-container">
                <button onclick="uploadCSV()">Submit</button>
            </div>
        </div>
        </div>
    </div>

    <!-- Logos at the bottom -->
    <div class="logos-container">
        <img src="{{ url_for('static', filename='logo1.png') }}" alt="KU Leuven" class="logo-ku">
        <img src="{{ url_for('static', filename='logo2.png') }}" alt="erc" class="logo-erc">
        <img src="{{ url_for('static', filename='logo3.png') }}" alt="fwo" class="logo-fwo">
    </div>
    
    <script>
        const defaultAbundances = {
        "H" : 0.7374078505762753,  "HE": 0.24924865007787272, "LI": 5.687053212055474e-11, "BE": 1.5816072816463046e-10,  
        "B" : 3.9638342804111373e-9, "C" : 2.3649741118292409e-3,  "N" : 6.927752331287037e-4,  "O" : 5.7328054948662952e-3,  
        "F" : 5.0460905860356957e-7, "NE": 1.2565170515587217e-3,  "NA": 2.9227131182144098e-6, "MG": 7.0785262928672096e-4,  
        "AL": 5.5631575894102415e-5, "SI": 6.6484690760698845e-4,  "P" : 5.8243105278933166e-6, "S" : 3.0923740022022601e-4,  
        "CL": 8.2016309032581489e-6, "AR": 7.3407809644158897e-5,  "K" : 3.0647973602772301e-6, "CA": 6.4143590291084783e-5,  
        "SC": 4.6455339921264288e-8, "TI": 3.1217731998425617e-6,  "V" : 3.1718648298183506e-7, "CR": 1.6604169480383736e-5,  
        "MN": 1.0817329760692272e-5, "FE": 1.2919540666812507e-3,  "CO": 4.2131387804051672e-6, "NI": 7.1254342166372973e-5,  
        "CU": 7.2000506248032108e-7, "ZN": 1.7368347374506484e-6
        } ;
        
        function navigateToTab(tabId) {
            // Update the hash in the URL (this also triggers hashchange event)
            window.location.hash = tabId;
        }

        function createAbundanceInputs() {
            const abundancesDiv = document.getElementById("abundances");
            abundancesDiv.style.display = "flex";
            abundancesDiv.style.flexWrap = "wrap";
            abundancesDiv.style.gap = "20px";

            let count = 0;
            let rowDiv = document.createElement("div");
            rowDiv.style.display = "flex";
            rowDiv.style.justifyContent = "space-between";
            rowDiv.style.width = "100%";

            const elementsPerRow = 4; // Now 4 instead of 3

            for (const [element, value] of Object.entries(defaultAbundances)) {
                const container = document.createElement("div");
                container.style.display = "flex";
                container.style.flexDirection = "column";
                container.style.width = "22%"; // Ensures 4 elements fit evenly within 100%

                const label = document.createElement("label");
                label.textContent = element;

                const input = document.createElement("input");
                input.type = "number";
                input.step = "any";
                input.value = value;
                input.id = `abundance-${element}`;

                container.appendChild(label);
                container.appendChild(input);
                rowDiv.appendChild(container);

                count++;

                if (count % elementsPerRow === 0) {
                    abundancesDiv.appendChild(rowDiv);
                    rowDiv = document.createElement("div");
                    rowDiv.style.display = "flex";
                    rowDiv.style.justifyContent = "space-between";
                    rowDiv.style.width = "100%";
                }
            }
        
            // Fill remaining spaces in the last row with empty placeholders
            const remaining = count % elementsPerRow;
            if (remaining !== 0) {
                for (let i = 0; i < elementsPerRow - remaining; i++) {
                    const placeholder = document.createElement("div");
                    placeholder.style.width = "22%"; // Same width as real input fields
                    placeholder.style.backgroundColor = "transparent"; // Keep it invisible
                    rowDiv.appendChild(placeholder);
                }
                abundancesDiv.appendChild(rowDiv);
            }
        }
        
        function adjustAbundances() {
            let totalMassFraction = 0;
            let nonHydrogenElements = [];
        
            for (const element of Object.keys(defaultAbundances)) {
                if (element !== "H") {
                    const input = document.getElementById(`abundance-${element}`);
                    const value = parseFloat(input.value) || 0;
                    totalMassFraction += value;
                    nonHydrogenElements.push({ element, value });
                }
            }
        
            const newHydrogenFraction = 1 - totalMassFraction;
            if (newHydrogenFraction >= 0) {
                document.getElementById("abundance-H").value = newHydrogenFraction.toExponential(8);
            } 
        }
        
        // Attach event listeners to all abundance inputs except hydrogen
        function attachAbundanceListeners() {
            for (const element of Object.keys(defaultAbundances)) {
                if (element !== "H") {
                    const input = document.getElementById(`abundance-${element}`);
                    input.addEventListener("input", adjustAbundances);
                }
            }
        }
        
        function updateAbundances() {
            const zscale = parseFloat(document.getElementById("zscale").value);
            if (isNaN(zscale)) return;
        
            let totalMetallicity = 0;
        
            // Scale all elements except H and He
            for (const element of Object.keys(defaultAbundances)) {
                if (element !== "H" && element !== "HE") {
                    const input = document.getElementById(`abundance-${element}`);
                    const newValue = defaultAbundances[element] * zscale;
                    input.value = newValue.toExponential(8);
                    totalMetallicity += newValue;
                }
            }
        
            // Keep Helium fixed and calculate new Hydrogen fraction
            const heliumFraction = parseFloat(document.getElementById("abundance-HE").value) || defaultAbundances["HE"];
            const newHydrogenFraction = 1 - (totalMetallicity + heliumFraction);
        
            if (newHydrogenFraction >= 0) {
                document.getElementById("abundance-H").value = newHydrogenFraction.toExponential(8);
            } else {
                alert("Error: The sum of abundances exceeds 1. Please adjust values.");
            }
        }

        function toggleEmailInput() {
            const emailContainer = document.getElementById("email-input-container");
            if (emailContainer.style.display === "none" || emailContainer.style.display === "") {
                emailContainer.style.display = "block";
            } else {
                emailContainer.style.display = "none";
            }
        }        

        function showTabFromHash() {
            const tabId = window.location.hash.substring(1) || 'info'; // default to 'info'
        
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
        
            tabs.forEach(tab => tab.classList.remove('active-tab'));
            contents.forEach(content => content.classList.remove('active-content'));
        
            document.querySelector(`.tab[onclick="navigateToTab('${tabId}')"]`)?.classList.add('active-tab');
            document.getElementById(tabId)?.classList.add('active-content');
        }

        // Call after creating the abundance inputs
        createAbundanceInputs();
        attachAbundanceListeners();
        
        function runCalculation() {
            const runButton = document.querySelector(".button-container button");
            const loadingIcon = document.getElementById("loading");

            // Disable the button to prevent multiple clicks
            runButton.disabled = true;
            runButton.textContent = "Running";

            // Get input values
            const luminosity = parseFloat(document.getElementById("luminosity").value);
            const teff = parseFloat(document.getElementById("teff").value);
            const mstar = parseFloat(document.getElementById("mstar").value);
            const zscale = parseFloat(document.getElementById("zscale").value);

             if (luminosity <= 0) {
                    alert("Please enter a higher luminosity.");
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }
             if (mstar <= 0) {
                    alert("Please enter a valid mass of the star.");
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }
             if (zscale < 0) {
                    alert("Please enter a valid metallicity of the star.");
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }

             if (!luminosity) {
                    alert("Please enter a luminosity.");
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }
             if (!mstar) {
                    alert("Please enter a mass.");
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }
             if (!zscale) {
                    alert("Please enter a metallicity.");
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }

             if (!teff) {
                    alert("Please enter an effective temperature.");
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }


            // Collect abundances
            let totalMassFraction = 0;
            const abundances = {};
        
            for (const element of Object.keys(defaultAbundances)) {
                const value = parseFloat(document.getElementById(`abundance-${element}`).value);
                
                if (isNaN(value) || value < 0) {
                    alert(`Invalid abundance for element ${element}. Please enter a valid non-negative number.`);
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }
        
                abundances[element] = value;
                totalMassFraction += value;
            }
        
            // Ensure the total mass fraction sums to exactly 1 with small tolerance for rounding errors
            if (Math.abs(totalMassFraction - 1) > 1e-8) { 
                alert(`The sum of all mass fractions must be exactly 1. Your current sum is ${totalMassFraction.toFixed(8)}.`);
                runButton.disabled = false; // Re-enable button
                runButton.textContent = "Run"; // Restore button text
                return;
            }    

            let email = "";
            if (document.getElementById("email-toggle").checked) {
                email = document.getElementById("user-email").value.trim();
                if (!email) {
                    alert("Please enter a valid email address.");
                    runButton.disabled = false; // Re-enable button
                    runButton.textContent = "Run"; // Restore button text
                    return;
                }
            }

            const expertMode = document.getElementById("expert-toggle").checked;

            // Show loading message
            document.getElementById("loading").style.display = "block";

            // Send request to start processing
            fetch("/process_data", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    luminosity, teff, mstar, zscale, abundances, email, expert_mode: expertMode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    // Start polling for task status
                    pollTaskStatus(data.task_id);
                }
                else {
                    // If no task ID is returned, show an error
                    document.getElementById("loading").style.display = "none";
                    runButton.disabled = false;
                    runButton.textContent = "Run";
                    alert(data.error || "An unexpected error occurred.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("There was an error processing the data.");

                document.getElementById("loading").style.display = "none";
                runButton.disabled = false;
                runButton.textContent = "Run";
            });
        }

        // Poll the task status
        function pollTaskStatus(taskId) {
            fetch(`/task_status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    runButton.disabled = true;
                    runButton.textContent = "Running";
                    if (data.done) {
                        document.getElementById("loading").style.display = "none";
                        runButton.disabled = false;
                        runButton.textContent = "Run";

                        document.getElementById("mass_loss_rate").textContent = data.mass_loss_rate;
                        document.getElementById("terminal_velocity").textContent = data.terminal_velocity;
                        document.getElementById("gamma_e").textContent = data.gamma_e;
                        document.getElementById("qbar").textContent = data.qbar;
                        document.getElementById("alpha").textContent = data.alpha;
                        document.getElementById("q0").textContent = data.q0;
                        document.getElementById("extra_info").textContent = data.info;

                        if (data.download_url) {
                            window.open(data.download_url, "_blank");
                        }
                    } else {
                        // If not done, check again in 0.1 seconds
                        setTimeout(() => pollTaskStatus(taskId), 100);
                    }
                })
                .catch(error => {
                    console.error("Error checking task status:", error);
                    alert("An error occurred while checking task status.");
                    document.getElementById("loading").style.display = "none";
                    runButton.disabled = false;
                    runButton.textContent = "Run";
                });
        }

        // CSV validation before upload
        document.getElementById("csvFile").addEventListener("change", function(event) {
            const file = event.target.files[0];
        
            if (!file) {
                alert("Please select a file.");
                return;
            }
        
            if (!file.name.endsWith(".csv")) {
                alert("Invalid file type. Please upload a CSV file.");
                event.target.value = "";
                return;
            }
        
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const rows = content.split("\n").map(row => row.trim().split(","));  
        
                if (rows.length < 2) {
                    alert("CSV file is empty or has no data.");
                    event.target.value = "";
                    return;
                }
        
                const headers = rows[0].map(h => h.trim());  
        
                // REQUIRED COLUMNS (CASE-SENSITIVE)
                const requiredColumns = ["name", "luminosity", "teff", "mstar", "zscale", "HE"];
                const missingColumns = requiredColumns.filter(col => !headers.includes(col));
        
                if (missingColumns.length > 0) {
                    alert(" Missing required columns: " + missingColumns.join(", "));
                    event.target.value = "";  
                    return;
                }
            };
        
            reader.readAsText(file);
        });

        function uploadCSV() {
            const email = document.getElementById('email-grid').value;
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
        
            if (!email || !file) {
                alert("Please enter an email and upload a CSV file.");
                return;
            }
            else{
                alert(`Successfully uploaded your file, you will get an email on ${email}`)
            }
        
            const formData = new FormData();
            formData.append("email", email);
            formData.append("file", file);

            
            fetch("/upload_csv", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert("Sucess:" + data.message);
                } else if (data.error) {
                    alert("Error: " + data.error);
                }
            })
        }

        function sendContactForm() {
            const name = document.getElementById("contact-name").value.trim();
            const email = document.getElementById("contact-email").value.trim();
            const message = document.getElementById("contact-message").value.trim();
            const attachment = document.getElementById("contact-attachment").files[0];
        
            if (!name || !email || !message) {
                alert("Please fill in all required fields.");
                return;
            }
        
            const formData = new FormData();
            formData.append("name", name);
            formData.append("email", email);
            formData.append("message", message);
            if (attachment) {
                formData.append("attachment", attachment);
            }
        
            fetch("/send_contact_email", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.attachment_oke) {
                        alert("Message sent successfully! You will receive a confirmation email.");
                    }
                    else {
                         alert("Please attach only CSV or PDF files. ");
                    }
                } else {
                    alert("Error sending message: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("There was an issue submitting the form.");
            });
        }

        window.addEventListener("load", () => {
              document.body.classList.add("loaded");
              showTabFromHash();
          });
        
          // Handle hash changes when user clicks or uses browser back/forward
          window.addEventListener("hashchange", showTabFromHash);    

    function toggleSidebar() {
        const sidebar = document.getElementById("mobileSidebar");
        sidebar.classList.toggle("show");
    }
    </script>
    <!-- Footer -->
    <div style="text-align: center; margin-top: 50px; padding: 20px; background-color: #a0cfa5; color: #2c3e50; font-size: 18px;">
        <p>For more information, contact <a href="https://www.kuleuven.be/wieiswie/nl/person/00141604">Dwaipayan Debnath</a>, <a href="https://www.kuleuven.be/wieiswie/nl/person/00168452">Frank Backs</a></p>
        <p>&copy; LIME. All rights reserved.</p>
    </div>
</body>
</html>
